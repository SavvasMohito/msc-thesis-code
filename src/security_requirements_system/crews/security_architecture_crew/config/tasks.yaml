design_security_architecture:
  description: >
    Based on the following information:

    Requirements:
    {requirements_text}

    Architecture:
    {architecture_summary}

    Components:
    {components}

    Security Controls:
    {security_controls}

    Your goal is to design comprehensive security architecture recommendations.

    CRITICAL INSTRUCTIONS:
    1. Define architectural_principles that should guide the implementation:
       - Zero Trust Architecture principles
       - Defense in Depth
       - Principle of Least Privilege
       - Secure by Default/Design
       - Separation of Duties
       - Fail Secure
       - Complete Mediation
       - Any other relevant principles
    
    2. For EACH major component identified in the architecture, provide component_controls:
       - Component name
       - List of required security controls specific to that component
       - Recommended architectural patterns (e.g., API Gateway with OAuth2,
         Encrypted Database with TDE, WAF for Web Frontend, etc.)
    
    3. Design a comprehensive data_protection_strategy:
       - Data classification scheme (Public, Internal, Confidential, Restricted)
       - Encryption requirements (algorithms, key lengths) for data at rest and in transit
       - Data retention policies aligned with compliance requirements
       - Data handling procedures (access, transmission, storage, deletion)
    
    4. For third_party_integrations (external APIs, payment gateways, EHR systems, etc.):
       - Identify each integration from the requirements
       - List specific security requirements (API keys, OAuth, mTLS, IP whitelisting, etc.)
       - Provide risk assessment for each integration
       - Recommend security controls (rate limiting, input validation, monitoring, etc.)
    
    5. Think holistically about how these elements work together to create a secure system
    
    6. Output as clean, well-formatted MARKDOWN matching the structure below.
    
    IMPORTANT: Output ONLY the markdown content WITHOUT any code block wrappers (no ```markdown tags).
    
  expected_output: >
    A comprehensive security architecture document in MARKDOWN format with the following structure:
    
    DO NOT wrap your output in ```markdown code blocks. Output the markdown content directly.
    
    ### 9.1. Architectural Security Principles
    
    Begin with an introduction paragraph explaining that architectural security principles provide the foundational philosophy guiding all security design decisions. These principles ensure consistent security posture across all system components and guide the selection and implementation of security controls. Then provide a bulleted list of principles (each in bold) with a brief explanation (1-2 sentences) of what each principle means and why it's important:
    
    - **Zero Trust Architecture principles**: Never trust, always verify. All access requests are authenticated and authorized regardless of location or network.
    - **Defense in Depth**: Multiple layers of security controls provide redundancy so that if one control fails, others provide protection.
    - **Principle of Least Privilege**: Users and systems are granted only the minimum access necessary to perform their functions.
    - **Secure by Default/Design**: Security is built into the system architecture from the ground up, not added as an afterthought.
    
    Include any other relevant principles specific to the system's security needs.
    
    ### 9.2. Component-Level Security Controls
    
    For EACH component, create a subsection (####) with the component name, then:
    
    #### Frontend User Interface
    
    **Required Controls:**
    - Control 1
    - Control 2
    
    **Recommended Patterns:**
    - Pattern 1
    - Pattern 2
    
    Example:
    #### Backend API
    
    **Required Controls:**
    - OAuth2 for API authentication
    - Rate Limiting
    - Input Validation
    - Error Handling and Logging
    
    **Recommended Patterns:**
    - API Gateway for service aggregation
    - Microservices architecture
    
    ### 9.3. Data Protection Strategy
    
    **Data Classification:** [scheme]
    
    **Encryption Requirements:** [details]
    
    **Retention Policies:** [details]
    
    **Handling Procedures:** [details]
    
    Example:
    **Data Classification:** Public, Internal, Confidential, Restricted
    
    **Encryption Requirements:** AES-256 for data at rest, TLS 1.2 or higher for data in transit
    
    **Retention Policies:** Data retention aligned with GDPR for EU customers and CCPA for US customers: retain data only as long as necessary for transaction completion and legal obligations.
    
    **Handling Procedures:** Data access must be logged, encrypted during transmission and at rest, and deleted securely when no longer needed.
    
    ### 9.4. Third-Party Integration Security
    
    For each integration, use bold for the name, then:
    
    **Integration Name**
    
    *Security Requirements:*
    - Requirement 1
    - Requirement 2
    
    *Risk Assessment:* [assessment]
    
    Example:
    **Stripe Payment Gateway**
    
    *Security Requirements:*
    - Use of secure API keys stored in environment variables
    - Implementation of OAuth for user sessions
    - Data transmitted only via secure endpoints (HTTPS)
    
    *Risk Assessment:* Critical - involves sensitive financial information; requires robust security measures to prevent breaches.
  agent: security_architect

