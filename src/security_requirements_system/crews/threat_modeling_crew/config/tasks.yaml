perform_threat_modeling:
  description: >
    Based on the following information:

    Application Requirements:
    {requirements_text}

    Architecture Summary:
    {architecture_summary}

    Components:
    {components}

    Your goal is to perform comprehensive threat modeling using the STRIDE methodology.

    CRITICAL INSTRUCTIONS:
    1. Use STRIDE (Spoofing, Tampering, Repudiation, Information Disclosure, 
       Denial of Service, Elevation of Privilege) as your primary methodology.
    
    2. For EACH component and high-level requirement, identify potential threats:
       - Assign unique threat IDs (THR-001, THR-002, etc.)
       - Identify which component or requirement the threat applies to
       - Categorize by STRIDE category
       - Provide a clear description of the threat scenario
       - Assess likelihood (High, Medium, Low) based on attack complexity and exposure
       - Assess impact (High, Medium, Low) based on potential damage
       - Calculate risk level (Critical, High, Medium, Low) based on likelihood × impact
       - Recommend specific mitigation strategies
    
    3. Consider common threat scenarios:
       - Authentication bypass and credential theft
       - SQL injection and code injection
       - Cross-site scripting (XSS) and CSRF
       - Broken access control and privilege escalation
       - Sensitive data exposure
       - API abuse and rate limiting issues
       - Third-party integration risks
       - Cloud infrastructure misconfigurations
    
    4. Provide a risk_summary highlighting:
       - The most critical threats requiring immediate attention
       - Overall risk posture
       - Key attack vectors and entry points
       - Recommended priority areas for security controls
    
    5. Think from an attacker's perspective and consider realistic attack scenarios
    
    6. Output as clean, well-formatted MARKDOWN matching the structure below.
  expected_output: >
    A ThreatModelingOutput Pydantic model with the following structure:
    
    {
      "methodology": "STRIDE (or other methodology used)",
      "threats": [
        {
          "threat_id": "THR-001",
          "component": "Component or requirement this threat applies to",
          "threat_category": "STRIDE category (e.g., Spoofing, Tampering, Repudiation, Information Disclosure, Denial of Service, Elevation of Privilege)",
          "description": "Detailed description of the threat scenario",
          "likelihood": "High/Medium/Low - based on attack complexity and exposure",
          "impact": "High/Medium/Low - based on potential damage",
          "risk_level": "Critical/High/Medium/Low - based on likelihood × impact",
          "mitigation_strategy": "Specific mitigation recommendations",
          "applicable_controls": ["V2.1.1", "V3.2.3"] // Optional: OWASP control IDs if known,
          "control_effectiveness": "High/Medium/Low" // Optional: estimate how effective controls are,
          "residual_risk_level": "Critical/High/Medium/Low/Negligible" // Optional: risk after controls,
          "residual_risk_acceptance": "Accepted/Requires Review/Unacceptable" // Optional: acceptance status
        }
      ],
      "risk_summary": "Comprehensive paragraph highlighting most critical threats, overall risk posture, key attack vectors, and priority areas for security controls"
    }
    
    CRITICAL INSTRUCTIONS:
    - Identify 20-40 threats covering all major components and requirements
    - For residual risk fields: If you have information about applicable controls from the context, 
      estimate their effectiveness and calculate residual risk. Otherwise, leave these fields null.
    - Risk calculation: 
      * High Likelihood + High Impact = Critical
      * High Likelihood + Medium Impact OR Medium Likelihood + High Impact = High
      * Medium Likelihood + Medium Impact OR High/Medium Likelihood + Low Impact = Medium
      * Low Likelihood + Low Impact = Low
    - Residual risk calculation:
      * High Control Effectiveness (80-100% reduction): typically reduces risk 2 levels
      * Medium Control Effectiveness (50-79% reduction): typically reduces risk 1 level
      * Low Control Effectiveness (20-49% reduction): typically reduces risk 0-1 levels
  agent: threat_modeling_expert

