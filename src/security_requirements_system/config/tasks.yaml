# Unified tasks configuration for Security Requirements Crew
# Tasks are executed sequentially, with each task able to access outputs from previous tasks via context

# 1. Requirements Analysis
analyze_requirements:
  description: >
    Analyze the following product manager requirements:

    {requirements_text}

    Your goal is to perform a comprehensive requirements analysis including detailed breakdown,
    security context, assumptions, and constraints.

    CRITICAL INSTRUCTIONS:
    1. Write a concise, one-paragraph summary of the application's main purpose.
    2. Decompose the requirements into a list of specific features (high_level_requirements).
       Each item should represent a distinct capability of the system.
       - Example: "User registration and login with multi-factor authentication"
       - Example: "A searchable product catalog with detailed item descriptions"
    3. For EACH high-level requirement, create a detailed analysis (detailed_requirements):
       - Assign a unique ID (REQ-001, REQ-002, etc.)
       - Categorize by business function (e.g., Authentication, Data Management, Payment Processing)
       - Assess security sensitivity (High, Medium, Low)
       - Determine data classification (Public, Internal, Confidential, Restricted)
       - Provide rationale for why this requirement exists
    4. Provide security_context: identify applicable regulations and compliance obligations
       based on the domain (e.g., HIPAA for healthcare, PCI-DSS for payments, GDPR for EU data)
    5. List key assumptions about the system (e.g., "System will be cloud-hosted", "Users have internet access")
    6. List technical and operational constraints (e.g., "Must integrate with legacy EHR systems")
    7. Ensure the output is a valid JSON object matching the AnalysisOutput schema.
  expected_output: >
    A comprehensive JSON object matching the AnalysisOutput schema with all optional fields populated.
  agent: requirements_analyst

# 2. Architecture Analysis
analyze_architecture:
  description: >
    Based on the previous requirements analysis and the following product manager requirements:

    {requirements_text}

    Your goal is to create a comprehensive system architecture analysis.

    CRITICAL INSTRUCTIONS:
    1.  Write a brief, one-paragraph summary of the proposed system architecture.
        Describe the main components (e.g., frontend, backend, database) and how they interact.

    2.  Generate a Mermaid diagram (using `graph TB` or `graph TD` syntax) to visually represent the architecture.
        CRITICAL MERMAID SYNTAX REQUIREMENTS - YOU MUST FOLLOW THESE EXACTLY:
        
        - Use ONLY `%%{init: {'theme':'dark'}}%%` at the start - NO other theme variables or custom styling
        - ALL node labels MUST be on a SINGLE LINE - multi-line labels are INVALID and will break rendering
        - Use spaces, slashes (/), ampersands (&), or hyphens (-) to separate text within labels
        - DO NOT use actual line breaks or newlines inside square brackets []
        - Example VALID syntax: `FE[Web App SPA & Admin UI]` or `API[Core API Users/Tasks/RBAC]`
        - Example INVALID syntax: `FE[Web App\nAdmin UI]` or `API[Core API\n(Users/Tasks)]` - DO NOT DO THIS
        
        DIAGRAM STRUCTURE REQUIREMENTS:
        - Keep the diagram SIMPLE and report-friendly - avoid excessive detail
        - Group related components into logical subgraphs (e.g., "Frontend Layer", "Application Services", "Data Layer", "External Services")
        - Use high-level component groupings rather than listing every individual service
        - Keep node labels concise and readable (use abbreviations if needed to fit on one line)
        - DO NOT use classDef or custom node styling
        - Focus on showing the main architectural layers and their relationships, not every internal component
        - Example structure: Users → Edge Layer → Frontend → Application Services → Data Layer → External Services
        
        VALIDATION CHECK: Before outputting, verify:
        - Every node label is on a single line (no line breaks inside brackets)
        - The diagram starts with `%%{init: {'theme':'dark'}}%%`
        - All subgraphs use double quotes: `subgraph "Layer Name"`
        - All connections use `-->` arrows

    3.  For EACH major HIGH-LEVEL component group (not individual services), provide analysis (components):
        - Component group name (e.g., "Frontend Layer", "Application Services", "Data Storage")
        - Its overall responsibility/purpose
        - Security criticality (Critical, High, Medium, Low)
        - Key external dependencies (major third-party services only)
        - Types of data it handles (high-level categories)
        Keep components at a high level - this is an initial understanding of building blocks, not detailed implementation

    4.  Describe data_flow_description: how data moves through the system at a high level, where it's stored,
        and key transformation points. Keep this concise and focused on major data flows.

    5.  Identify trust_boundaries: different trust zones in the system (e.g., "Internet", "DMZ", 
        "Internal Network", "Database Tier") and the security controls protecting each boundary.

    6.  Provide attack_surface_analysis: entry points, exposed APIs, user interfaces,
        integration points, and their associated risk levels. Focus on major attack surfaces.

    7.  Ensure the output is a valid JSON object matching the ArchitectureOutput schema.
  expected_output: >
    A comprehensive JSON object matching the ArchitectureOutput schema with all optional fields populated.
  agent: system_architect
  context:
    - analyze_requirements

# 3. Stakeholder and Compliance Analysis (merged task)
analyze_stakeholders_and_compliance:
  description: >
    Based on the application requirements and architecture:

    Requirements:
    {requirements_text}

    Your goal is to perform comprehensive stakeholder AND compliance analysis.
    
    IMPORTANT: You have access to outputs from previous tasks through CrewAI's automatic context:
    - From analyze_requirements: application_summary, high_level_requirements, detailed_requirements, security_context
    - From analyze_architecture: architecture_summary, architecture_diagram, components, trust_boundaries
    Use these outputs to inform your analysis. Reference specific requirements and components when relevant.

    PART A: STAKEHOLDER ANALYSIS
    1. Identify ALL stakeholders and user personas in the system. For each, provide:
       - Role name (e.g., "Patient", "Healthcare Provider", "System Administrator")
       - Description of the role and their typical activities
       - Privilege level (e.g., Admin, User, Guest, Service Account)
       - Key security concerns specific to this role
       - Trust level (Trusted, Partially Trusted, Untrusted)

    2. Consider both human and automated stakeholders:
       - End users (patients, customers, etc.)
       - Administrative users
       - Third-party integrators
       - Service accounts and APIs
       - External systems

    3. Describe the trust model:
       - How are trust boundaries established?
       - What security mechanisms enforce boundaries (authentication, authorization, network segmentation)?
       - Which stakeholders can access which data/functionality?
       - How does the principle of least privilege apply?

    PART B: COMPLIANCE ANALYSIS
    1. Identify compliance triggers:
       - Personal data handling → GDPR, CCPA
       - Health information → HIPAA, HITECH
       - Payment card data → PCI-DSS
       - Financial data → SOX, GLBA
       - Children's data → COPPA
       - Geographic restrictions → Data residency laws
       - Industry-specific regulations

    2. For each applicable regulation:
       - Identify specific compliance requirements
       - Map to necessary security controls
       - Identify data subject rights that must be supported
       - Specify retention and deletion requirements
       - Define consent and privacy notice needs
       - Identify breach notification requirements
       - Specify audit and logging needs

    Output as clean, well-formatted MARKDOWN matching the expected structure.
  expected_output: >
    A comprehensive document in MARKDOWN format combining stakeholder analysis and compliance requirements.
    IMPORTANT: Output the markdown content directly. DO NOT wrap your output in ```markdown code blocks.
  agent: compliance_and_regulatory_analyst
  context:
    - analyze_requirements
    - analyze_architecture

# 4. Threat Modeling
perform_threat_modeling:
  description: >
    Based on the following information from previous analyses:

    Application Requirements:
    {requirements_text}

    Your goal is to perform comprehensive threat modeling using the STRIDE methodology.
    
    Note: You have access to outputs from previous tasks (requirements analysis and architecture analysis) 
    through the automatic context provided by CrewAI. Use this context to inform your threat analysis.

    CRITICAL INSTRUCTIONS:
    1. Use STRIDE (Spoofing, Tampering, Repudiation, Information Disclosure, 
       Denial of Service, Elevation of Privilege) as your primary methodology.

    2. For EACH component and high-level requirement, identify potential threats:
       - Assign unique threat IDs (THR-001, THR-002, etc.)
       - Identify which component or requirement the threat applies to
       - Categorize by STRIDE category
       - Provide a clear description of the threat scenario
       - Assess likelihood (High, Medium, Low) based on attack complexity and exposure
       - Assess impact (High, Medium, Low) based on potential damage
       - Calculate risk level (Critical, High, Medium, Low) based on likelihood × impact
       - Recommend specific mitigation strategies

    3. Consider common threat scenarios:
       - Authentication bypass and credential theft
       - SQL injection and code injection
       - Cross-site scripting (XSS) and CSRF
       - Broken access control and privilege escalation
       - Sensitive data exposure
       - API abuse and rate limiting issues
       - Third-party integration risks
       - Cloud infrastructure misconfigurations

    4. Provide a risk_summary highlighting:
       - The most critical threats requiring immediate attention
       - Overall risk posture
       - Key attack vectors and entry points
       - Recommended priority areas for security controls

    5. Think from an attacker's perspective and consider realistic attack scenarios
  expected_output: >
    A ThreatModelingOutput Pydantic model identifying 20-40 threats covering all major components and requirements.
  agent: threat_modeling_expert
  context:
    - analyze_requirements
    - analyze_architecture

# 5. Security Controls Mapping
map_security_controls:
  description: >
    You have been provided with high-level functional requirements from previous analysis.
    
    IMPORTANT: You have access to outputs from previous tasks through CrewAI's automatic context:
    - From analyze_requirements: high_level_requirements, detailed_requirements (with IDs like REQ-001, REQ-002)
    Use these to understand which requirements need security controls mapped.

    Your task is to map each requirement to relevant security controls from OWASP ASVS, NIST SP 800-53, and ISO 27001.

    Instructions:
    1. For each requirement, use the "Query Security Standards Database" tool to find relevant controls.
       IMPORTANT: Call the tool correctly by passing a dictionary with 'query' as a string.
       Example tool call: Use query="authentication multi-factor" with limit=10.
       Do NOT wrap the arguments in a list. Do NOT include results in the tool call.
       Do NOT specify a standard_filter - let the tool find the best matches across all standards.

    2. From the tool results, select 3-8 most relevant controls per requirement.
       Use the EXACT data from the tool output: standard, req_id, chapter, section, requirement text, level.

    3. For each control, provide:
       - relevance: Why this control applies (2-3 sentences)
       - integration_tips: How to implement it (2-3 sentences)
       - priority: Critical, High, Medium, or Low
       - verification_method: How to verify implementation

    4. Identify cross_functional_controls that apply globally (logging, encryption, error handling).

    5. Recommend a recommended_asvs_level (L1, L2, or L3) based on data sensitivity and compliance needs.

    IMPORTANT: You MUST use the tool to find controls. Copy control data exactly from tool results.
  expected_output: >
    A JSON object matching DomainSecurityOutput schema with security_controls for each requirement.
    Each control must include the standard field ("OWASP", "NIST", or "ISO27001").
  agent: domain_security_expert
  context:
    - analyze_requirements

# 6. AI/ML Security Analysis
identify_ai_security_requirements:
  description: >
    Review the requirements and existing analyses from previous tasks:

    Original Requirements:
    {requirements_text}

    IMPORTANT: You have access to outputs from previous tasks through CrewAI's automatic context:
    - From analyze_requirements: high_level_requirements, detailed_requirements
    Review these to identify any AI/ML components mentioned (LLMs, chatbots, ML models, recommendation systems, etc.).

    Determine if the application involves:
    1. Natural language processing or generation
    2. Large Language Models (LLMs) or AI assistants
    3. Machine learning models or AI-powered features
    4. Chatbots or conversational interfaces
    5. Content generation or summarization
    6. Recommendation systems
    7. Image/video generation or analysis

    If AI/ML components are present or likely, identify and recommend controls for:
    - Prompt injection prevention
    - Input validation for AI inputs
    - Output filtering and sanitization
    - Data leakage prevention (PII in training/prompts)
    - Model access controls
    - Rate limiting and abuse prevention
    - Monitoring for adversarial inputs
    - Model versioning and rollback capabilities
    - Supply chain security for models
    - Bias and fairness considerations
  expected_output: >
    A specialized AI/ML security requirements document in MARKDOWN format.
    If no AI/ML components detected, return: "*No AI/ML components detected in the system.*"
    IMPORTANT: Output the markdown content directly. DO NOT wrap your output in ```markdown code blocks.
  agent: specialized_security_analyst
  context:
    - analyze_requirements

# 7. Security Architecture Design
design_security_architecture:
  description: >
    Based on all previous analyses:

    Requirements:
    {requirements_text}

    Your goal is to design comprehensive security architecture recommendations.
    
    IMPORTANT: You have access to outputs from previous tasks through CrewAI's automatic context:
    - From analyze_requirements: detailed_requirements, security_context
    - From analyze_architecture: components, trust_boundaries, attack_surface_analysis
    - From map_security_controls: security_controls (with mapped controls per requirement)
    Use these to design security architecture that addresses identified threats and implements mapped controls.

    CRITICAL INSTRUCTIONS:
    1. Define architectural_principles that should guide the implementation
    2. For EACH major component, provide component_controls with required security controls
       and recommended architectural patterns
    3. Design a comprehensive data_protection_strategy
    4. For third_party_integrations, identify security requirements and risk assessments
    5. Think holistically about how these elements work together to create a secure system

    Output as clean, well-formatted MARKDOWN matching the expected structure.
  expected_output: >
    A comprehensive security architecture document in MARKDOWN format.
    DO NOT wrap your output in ```markdown code blocks. Output the markdown content directly.
  agent: security_architect
  context:
    - analyze_requirements
    - analyze_architecture
    - map_security_controls

# 8. Implementation Roadmap and Testing Strategy (merged task)
create_implementation_and_testing_plan:
  description: >
    Based on all security analyses performed:

    Requirements:
    {requirements_text}

    Your goal is to create a comprehensive implementation roadmap AND testing strategy.
    
    IMPORTANT: You have access to outputs from previous tasks through CrewAI's automatic context:
    - From analyze_requirements: detailed_requirements, security_context
    - From map_security_controls: security_controls (with priorities: Critical, High, Medium, Low)
    - From perform_threat_modeling: threats (with risk levels)
    - From analyze_stakeholders_and_compliance: compliance requirements, stakeholder analysis
    Use these to prioritize implementation phases and design comprehensive testing strategies.

    PART A: IMPLEMENTATION ROADMAP
    1. Define prioritization_criteria (risk level, compliance deadlines, technical complexity, etc.)
    2. Create implementation phases:
       - IMMEDIATE (0-1 months): Critical, high-risk items
       - SHORT-TERM (1-3 months): High-priority controls
       - MEDIUM-TERM (3-6 months): Important controls requiring planning
       - LONG-TERM (6-12 months): Strategic initiatives
       - ONGOING: Continuous activities
    3. For EACH phase, provide timeline, rationale, controls to implement, and dependencies
    4. Include resource_requirements (skills, tools, estimated effort)

    PART B: TESTING STRATEGY
    1. Define overall testing_approach (SDLC integration, risk-based prioritization)
    2. Provide detailed testing_methods (SAST, DAST, dependency scanning, penetration testing, etc.)
    3. Define compliance_verification approach
    4. Define continuous_monitoring strategy
    5. Define KPIs (MTTD, MTTR, coverage %, etc.)

    Output as clean, well-formatted MARKDOWN matching the expected structure.
  expected_output: >
    A comprehensive document combining implementation roadmap and testing strategy in MARKDOWN format.
    IMPORTANT: Output the markdown content directly. DO NOT wrap your output in ```markdown code blocks.
  agent: implementation_and_testing_specialist
  context:
    - analyze_requirements
    - map_security_controls
    - perform_threat_modeling
    - analyze_stakeholders_and_compliance

# 9. Validation
validate_security_requirements:
  description: >
    Validate the generated security requirements against the original business requirements:

    Original Requirements:
    {requirements_text}

    Perform comprehensive validation:
    
    IMPORTANT: You have access to outputs from ALL previous tasks through CrewAI's automatic context:
    - analyze_requirements: original requirements and analysis
    - map_security_controls: mapped security controls
    - identify_ai_security_requirements: AI/ML-specific controls (if applicable)
    - analyze_stakeholders_and_compliance: compliance and stakeholder requirements
    - perform_threat_modeling: identified threats and mitigations
    - design_security_architecture: security architecture recommendations
    Validate that all these elements work together cohesively and comprehensively address security needs.

    1. COMPLETENESS (0-1 score):
       - Are all identified security concerns addressed?
       - Are there missing security domains?
       - Is coverage comprehensive across authentication, authorization, data protection, etc.?

    2. CONSISTENCY (0-1 score):
       - Do requirements contradict each other?
       - Are similar concerns handled consistently?
       - Do controls work together harmoniously?

    3. CORRECTNESS (0-1 score):
       - Are controls appropriate for identified risks?
       - Are standards applied correctly?
       - Are AI/ML controls relevant if AI is present?

    4. IMPLEMENTABILITY (0-1 score):
       - Are requirements specific and actionable?
       - Can developers implement these?
       - Are there ambiguous or vague requirements?

    5. ALIGNMENT (0-1 score):
       - Do security requirements align with business requirements?
       - Are we securing what actually needs to be built?
       - Are we over-engineering or under-protecting?

    Calculate overall score (average of above 5 scores).

    If score < 0.7, provide specific, actionable feedback on what to improve.
  expected_output: >
    A JSON object matching the ValidationOutput schema.
  agent: validation_expert
  context:
    - analyze_requirements
    - map_security_controls
    - identify_ai_security_requirements
    - analyze_stakeholders_and_compliance
